http {
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    
    server {
        listen 8080;
        server_name localhost;
        server_tokens off;

        location /authapi/ {
            proxy_pass http://localhost:3001;
        }

        location = /auth {
            internal;
            proxy_pass http://localhost:3001/authapi/authenticate;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Authorization $http_authorization;
        }

        location /productapi/ {
            proxy_pass http://localhost:3004;
        }

        location /customerapi/ {
            auth_request /auth;
            auth_request_set $auth_status $upstream_status;

            error_page 401 = @auth_failed;
            error_page 500 = @auth_failed;

            proxy_pass http://localhost:3002;
        }

        location @auth_failed {
            add_header Content-Type application/json;
            return 401 '{"error": "Authentication failed"}';
        }
    }
}

events {}
